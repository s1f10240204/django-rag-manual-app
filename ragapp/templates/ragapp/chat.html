{% extends 'ragapp/base.html' %}
{% block title %}チャット - {{ product_name }}{% endblock %}

{% block content %}
<div class="content-card chat-window">
    <header class="chat-header">
        <span>{{ product_name }}</span>
        <a href="{% url 'load_manual' %}" class="float-end">別の製品へ</a>
    </header>
    <main class="chat-body" id="chat-body"></main>
    <footer class="chat-footer">
        <form id="chat-form">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="メッセージを入力..." autocomplete="off">
                <button class="btn btn-gradient" type="submit">送信</button>
            </div>
        </form>
    </footer>
</div>

<script>
const chatBody = document.getElementById('chat-body');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

function addMessage(author, content) {
    const isAI = author === 'AI';
    const messageWrapper = document.createElement('div');
    messageWrapper.style.display = 'flex';
    if(author === 'You') messageWrapper.style.justifyContent = 'flex-end';

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('chat-bubble', isAI ? 'ai-message' : 'user-message');
    messageDiv.innerHTML = content;
    
    messageWrapper.appendChild(messageDiv);
    chatBody.appendChild(messageWrapper);
    chatBody.scrollTop = chatBody.scrollHeight;
}

function toggleTypingIndicator(show) {
    let indicator = document.getElementById('typing-indicator');
    if (show) {
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.style.display = 'flex';
            indicator.innerHTML = `<div class="chat-bubble ai-message"><span>.</span><span>.</span><span>.</span></div>`;
            chatBody.appendChild(indicator);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    } else {
        if (indicator) indicator.remove();
    }
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const question = chatInput.value.trim();
    if (!question) return;
    addMessage('You', question);
    chatInput.value = '';
    toggleTypingIndicator(true);
    const formData = new FormData();
    formData.append('question', question);
    try {
        const response = await fetch("{% url 'chat_api' %}", { method: 'POST', body: formData });
        const data = await response.json();
        toggleTypingIndicator(false);
        addMessage('AI', data.answer.replace(/\n/g, '<br>'));
    } catch (error) {
        toggleTypingIndicator(false);
        addMessage('AI', 'エラーが発生しました。');
    }
});

addMessage('AI', `こんにちは！「${"{{ product_name }}"}」の取扱説明書について、何でも聞いてください。`);
</script>
{% endblock %}